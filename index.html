<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS - ÊåëÊà¶ËÄÖÁâπÂåñÂûãSNS</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
        }
        .nexus-bg {
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
        }
        .nexus-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e0e7ff;
        }
        .nexus-button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }
        .nexus-button:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .nexus-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .nexus-input {
            border: 2px solid #e0e7ff;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }
        .nexus-input:focus {
            border-color: #3b82f6;
            background: white;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .nexus-notification {
            background: #ef4444;
            color: white;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .nexus-tag {
            color: #3b82f6;
            font-weight: 500;
        }
        .nexus-phase {
            background: #dbeafe;
            color: #1e40af;
            border-left: 3px solid #3b82f6;
        }
        .nexus-like {
            color: #ef4444;
        }
        .message-bubble {
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .unread-indicator {
            background: #dbeafe;
            border-left: 3px solid #3b82f6;
        }
        .read-indicator {
            opacity: 0.6;
        }
        .place-card {
            background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }
        .place-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        .coupon-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .location-marker {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #3b82f6;
            border-radius: 50%;
            margin-right: 4px;
        }
        .mbti-badge {
            background: #e0d4ff;
            color: #7c3aed;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 4px;
        }
        .post-type-badge {
            background: #fecaca;
            color: #991b1b;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .post-type-badge.business {
            background: #a7f3d0;
            color: #065f46;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_BASE = '';

        function NEXUS() {
            const [users, setUsers] = useState([]);
            const [posts, setPosts] = useState([]);
            const [messages, setMessages] = useState([]);
            const [groupChats, setGroupChats] = useState([]);
            const [locations, setLocations] = useState([]);
            const [places, setPlaces] = useState([]);
            const [currentUserId] = useState('user1');
            const [activeTab, setActiveTab] = useState('posts');
            const [messengerMode, setMessengerMode] = useState('dm');
            const [feedType, setFeedType] = useState('recommend');
            const [selectedTalk, setSelectedTalk] = useState(null);
            const [selectedGroupChat, setSelectedGroupChat] = useState(null);
            const [selectedProfile, setSelectedProfile] = useState(null);
            const [newPostContent, setNewPostContent] = useState('');
            const [newMessageContent, setNewMessageContent] = useState('');
            const [newGroupChatName, setNewGroupChatName] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedLocation, setSelectedLocation] = useState(null);
            const [mbtiFilter, setMbtiFilter] = useState('all');
            const [loading, setLoading] = useState(true);
            const messagesEndRef = useRef(null);

           useEffect(() => {
    fetchData();
}, []);

useEffect(() => {
    if (!selectedTalk && !selectedGroupChat) {
        const interval = setInterval(fetchData, 5000);
        return () => clearInterval(interval);
    }
}, [selectedTalk, selectedGroupChat]);

            useEffect(() => {
                scrollToBottom();
            }, [messages, selectedTalk, groupChats, selectedGroupChat]);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            const fetchData = async () => {
    const savedMessageContent = newMessageContent; // ÂÖ•Âäõ„Çí‰øùÂ≠ò
    try {
        const [usersRes, postsRes, messagesRes, groupChatsRes, locationsRes] = await Promise.all([
            fetch(`${API_BASE}/api/users`),
            fetch(`${API_BASE}/api/posts`),
            fetch(`${API_BASE}/api/messages`),
            fetch(`${API_BASE}/api/groupchats`),
            fetch(`${API_BASE}/api/locations`)
        ]);

        const usersData = await usersRes.json();
        const postsData = await postsRes.json();
        const messagesData = await messagesRes.json();
        const groupChatsData = await groupChatsRes.json();
        const locationsData = await locationsRes.json();

        setUsers(usersData);
        setPosts(postsData);
        setMessages(messagesData);
        setGroupChats(groupChatsData);
        setLocations(locationsData);
        setNewMessageContent(savedMessageContent); // ÂÖ•Âäõ„ÇíÂæ©ÂÖÉ
        setLoading(false);
    } catch (error) {
        console.error('Failed to fetch data:', error);
        setNewMessageContent(savedMessageContent); // „Ç®„É©„ÉºÊôÇ„ÇÇÂæ©ÂÖÉ
        setLoading(false);
    }
};
            const fetchPlaces = async (location) => {
                try {
                    const response = await fetch(`${API_BASE}/api/places/${encodeURIComponent(location)}`);
                    const data = await response.json();
                    setPlaces(data.places);
                    setSelectedLocation(location);
                } catch (error) {
                    console.error('Failed to fetch places:', error);
                }
            };

            const getCurrentUser = () => users.find(u => u.id === currentUserId);
            const getUserById = (id) => users.find(u => u.id === id);
            const getPostAuthor = (post) => getUserById(post.authorId);

            const getUnreadDMCount = () => {
                return messages.filter(m => m.recipientId === currentUserId && !m.isRead).length;
            };

            const getUnreadGroupCount = () => {
                return groupChats.reduce((count, gc) => {
                    return count + gc.messages.filter(m => m.recipientId === currentUserId && !m.isRead).length;
                }, 0);
            };

            const getTalks = () => {
                const talkMap = {};
                messages.forEach(msg => {
                    const otherId = msg.senderId === currentUserId ? msg.recipientId : msg.senderId;
                    if (!talkMap[otherId]) {
                        talkMap[otherId] = {
                            participantId: otherId,
                            messages: [],
                            lastMessage: '',
                            lastMessageTime: ''
                        };
                    }
                    talkMap[otherId].messages.push(msg);
                    talkMap[otherId].lastMessage = msg.message;
                    talkMap[otherId].lastMessageTime = msg.timestamp;
                });
                return Object.values(talkMap).sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
            };

            const getTalkMessages = (participantId) => {
                return messages.filter(
                    m => (m.senderId === currentUserId && m.recipientId === participantId) ||
                         (m.senderId === participantId && m.recipientId === currentUserId)
                ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            };

            const getGroupChatMessages = (groupChatId) => {
                const groupChat = groupChats.find(g => g.id === groupChatId);
                return groupChat ? groupChat.messages : [];
            };

            const getSearchResults = () => {
                const query = searchQuery.toLowerCase();
                return posts.filter(post => {
                    const author = getPostAuthor(post);
                    return (
                        post.content.toLowerCase().includes(query) ||
                        author?.name.toLowerCase().includes(query) ||
                        author?.username.toLowerCase().includes(query) ||
                        post.hashtags?.some(tag => tag.toLowerCase().includes(query))
                    );
                });
            };

            const getFilteredPostsByMBTI = () => {
                const filtered = mbtiFilter === 'all' 
                    ? posts 
                    : posts.filter(p => {
                        const author = getPostAuthor(p);
                        return author?.mbti === mbtiFilter;
                    });
                
                if (feedType === 'following') {
                    const followingIds = getCurrentUser()?.following || [];
                    return filtered.filter(p => followingIds.includes(p.authorId));
                }
                return filtered;
            };

            const handleAddPost = async () => {
                if (newPostContent.trim()) {
                    try {
                        const currentUser = getCurrentUser();
                        const response = await fetch(`${API_BASE}/api/posts`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                authorId: currentUserId, 
                                content: newPostContent,
                                location: currentUser?.location,
                                postType: 'personal'
                            })
                        });
                        const newPost = await response.json();
                        setPosts([newPost, ...posts]);
                        setNewPostContent('');
                    } catch (error) {
                        console.error('Failed to create post:', error);
                    }
                }
            };

            const handleToggleLike = async (postId) => {
                try {
                    const response = await fetch(`${API_BASE}/api/posts/${postId}/like`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUserId })
                    });
                    const updatedPost = await response.json();
                    setPosts(posts.map(p => p.id === postId ? updatedPost : p));
                } catch (error) {
                    console.error('Failed to toggle like:', error);
                }
            };

            const handleFollowToggle = (userId) => {
                setUsers(users.map(u => {
                    if (u.id === currentUserId) {
                        return {
                            ...u,
                            following: u.following.includes(userId) 
                                ? u.following.filter(id => id !== userId)
                                : [...u.following, userId]
                        };
                    }
                    if (u.id === userId) {
                        return {
                            ...u,
                            followers: u.followers.includes(currentUserId)
                                ? u.followers.filter(id => id !== currentUserId)
                                : [...u.followers, currentUserId]
                        };
                    }
                    return u;
                }));
            };

            const handleSendMessage = async (recipientId) => {
                if (newMessageContent.trim()) {
                    try {
                        const response = await fetch(`${API_BASE}/api/messages`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ senderId: currentUserId, recipientId, message: newMessageContent })
                        });
                        const newMsg = await response.json();
                        setMessages([...messages, newMsg]);
                        setNewMessageContent('');
                        setTimeout(scrollToBottom, 100);
                    } catch (error) {
                        console.error('Failed to send message:', error);
                    }
                }
            };

            const handleSendGroupMessage = async (groupChatId) => {
                if (newMessageContent.trim()) {
                    try {
                        const response = await fetch(`${API_BASE}/api/groupchats/${groupChatId}/messages`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ senderId: currentUserId, content: newMessageContent })
                        });
                        const newMsg = await response.json();
                        setGroupChats(groupChats.map(gc => 
                            gc.id === groupChatId 
                                ? { ...gc, messages: [...gc.messages, newMsg] }
                                : gc
                        ));
                        setNewMessageContent('');
                        setTimeout(scrollToBottom, 100);
                    } catch (error) {
                        console.error('Failed to send group message:', error);
                    }
                }
            };

            const handleCreateGroupChat = async () => {
                if (newGroupChatName.trim()) {
                    try {
                        const response = await fetch(`${API_BASE}/api/groupchats`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                name: newGroupChatName,
                                members: [currentUserId]
                            })
                        });
                        const newGroupChat = await response.json();
                        setGroupChats([...groupChats, newGroupChat]);
                        setNewGroupChatName('');
                    } catch (error) {
                        console.error('Failed to create group chat:', error);
                    }
                }
            };

            const handleMarkAsRead = (participantId) => {
                setMessages(messages.map(m => {
                    if (m.recipientId === currentUserId && m.senderId === participantId && !m.isRead) {
                        return { ...m, isRead: true };
                    }
                    return m;
                }));
            };

            const formatTime = (timestamp) => {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return '‰ªä';
                if (minutes < 60) return `${minutes}ÂàÜÂâç`;
                if (hours < 24) return `${hours}ÊôÇÈñìÂâç`;
                if (days < 7) return `${days}Êó•Ââç`;
                return date.toLocaleDateString('ja-JP');
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-screen nexus-bg">
                        <div className="text-center">
                            <div className="text-4xl mb-4">üì±</div>
                            <p className="text-gray-600 text-lg">NEXUS Ë™≠Ëæº‰∏≠...</p>
                        </div>
                    </div>
                );
            }

            const currentUser = getCurrentUser();
            if (!currentUser) return <div className="text-center p-8">„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>;

            const displayPosts = searchQuery ? getSearchResults() : getFilteredPostsByMBTI();
            const talks = getTalks();const PostCard = ({ post }) => {
                const author = getPostAuthor(post);
                const isLiked = post.likes.includes(currentUserId);

                return (
                    <div className="nexus-card border-b hover:bg-blue-50 transition p-4">
                        <div className="flex gap-3">
                            <div className="text-3xl">{author?.avatar}</div>
                            <div className="flex-1">
                                <div className="flex items-center gap-2 flex-wrap">
                                    <span className="post-type-badge" style={{background: post.postType === 'business' ? '#a7f3d0' : '#fecaca', color: post.postType === 'business' ? '#065f46' : '#991b1b'}}>
                                        {post.postType === 'business' ? '„Éì„Ç∏„Éç„Çπ' : '„Éë„Éº„ÇΩ„Éä„É´'}
                                    </span>
                                    <span className="font-bold hover:underline cursor-pointer text-gray-900" onClick={() => setSelectedProfile(author?.id)}>
                                        {author?.name}
                                    </span>
                                    <span className="text-gray-500 text-sm">{author?.username}</span>
                                    <span className="mbti-badge">{author?.mbti}</span>
                                    <span className="nexus-phase px-2 py-1 rounded text-xs font-bold">
                                        {author?.phase}
                                    </span>
                                    <span className="text-gray-400 text-xs ml-auto">{formatTime(post.timestamp)}</span>
                                </div>
                                <p className="mt-3 text-gray-800 text-sm leading-relaxed">{post.content}</p>
                                {post.location && (
                                    <div className="mt-2 flex items-center text-sm text-blue-600 cursor-pointer hover:text-blue-700" onClick={() => fetchPlaces(post.location)}>
                                        <span className="location-marker"></span>
                                        üìç {post.location}
                                    </div>
                                )}
                                {post.hashtags && post.hashtags.length > 0 && (
                                    <div className="mt-3 flex flex-wrap gap-2">
                                        {post.hashtags.map((tag, i) => (
                                            <span key={i} className="nexus-tag text-sm cursor-pointer hover:text-blue-700" onClick={() => setSearchQuery(tag.replace('#', ''))}>
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                )}
                                {post.eventInfo && (
                                    <div className="mt-3 p-2 bg-green-50 rounded border border-green-200">
                                        <p className="text-sm font-bold text-green-800">üìÖ {post.eventInfo.type === 'internship' ? '„Ç§„É≥„Çø„Éº„É≥„Ç∑„ÉÉ„Éó' : '„Ç§„Éô„É≥„Éà'}</p>
                                        <p className="text-xs text-green-700">{post.eventInfo.startDate} - {post.eventInfo.endDate}</p>
                                        {post.eventInfo.salary && <p className="text-xs text-green-700">Áµ¶‰∏é: {post.eventInfo.salary}</p>}
                                    </div>
                                )}
                                <div className="flex items-center gap-6 mt-4 text-gray-500">
                                    <button
                                        onClick={() => handleToggleLike(post.id)}
                                        className={`flex items-center gap-2 transition ${isLiked ? 'nexus-like' : 'hover:text-red-500'}`}
                                    >
                                        <span className="text-lg">{isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                                        <span className={`text-sm font-bold ${isLiked ? 'nexus-like' : ''}`}>
                                            {post.likeCount}
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const DMTalkCard = ({ talk }) => {
                const participant = getUserById(talk.participantId);
                const unreadCount = getTalkMessages(talk.participantId).filter(m => m.recipientId === currentUserId && !m.isRead).length;

                return (
                    <div
                        onClick={() => {
                            setSelectedTalk(talk.participantId);
                            handleMarkAsRead(talk.participantId);
                        }}
                        className={`nexus-card border-b hover:bg-blue-50 cursor-pointer transition p-4 flex items-center justify-between ${unreadCount > 0 ? 'unread-indicator' : 'read-indicator'}`}
                    >
                        <div className="flex-1">
                            <div className="flex items-center gap-3">
                                <span className="text-2xl">{participant?.avatar}</span>
                                <div className="flex-1">
                                    <div className="font-bold text-gray-900">{participant?.name}</div>
                                    <div className="text-sm text-gray-600 truncate">{talk.lastMessage}</div>
                                </div>
                            </div>
                        </div>
                        {unreadCount > 0 && (
                            <div className="nexus-notification rounded-full w-7 h-7 flex items-center justify-center text-xs font-bold ml-3">
                                {unreadCount}
                            </div>
                        )}
                    </div>
                );
            };

            const GroupChatCard = ({ groupChat }) => {
                return (
                    <div
                        onClick={() => setSelectedGroupChat(groupChat.id)}
                        className="nexus-card border-b hover:bg-blue-50 cursor-pointer transition p-4"
                    >
                        <div className="flex items-center justify-between">
                            <div className="flex-1">
                                <h3 className="font-bold text-gray-900">{groupChat.name}</h3>
                                <p className="text-sm text-gray-600">
                                    {groupChat.members.length}‰∫∫ ‚Ä¢ ÊúÄÊñ∞: {groupChat.messages.length > 0 ? formatTime(groupChat.messages[groupChat.messages.length - 1].timestamp) : 'Êú™ÈÄÅ‰ø°'}
                                </p>
                            </div>
                        </div>
                    </div>
                );
            };

            const LocationCard = ({ location }) => (
                <div 
                    onClick={() => fetchPlaces(location.location)}
                    className="nexus-card border-b hover:bg-blue-50 cursor-pointer transition p-4 flex items-center justify-between"
                >
                    <div className="flex-1">
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">{location.avatar}</span>
                            <div className="flex-1">
                                <div className="font-bold text-gray-900">{location.name}</div>
                                <div className="text-sm text-blue-600 flex items-center">
                                    <span className="location-marker"></span>
                                    üìç {location.location}
                                </div>
                                <div className="nexus-phase inline-block px-2 py-1 rounded text-xs font-bold mt-1">
                                    {location.phase}
                                </div>
                                <div className="mbti-badge">{location.mbti}</div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const PlaceCard = ({ place }) => (
                <div className="place-card rounded-lg p-4 mb-3">
                    <div className="flex justify-between items-start">
                        <div>
                            <h4 className="font-bold text-gray-900">{place.name}</h4>
                            <p className="text-sm text-gray-600 mt-1">{place.type}</p>
                            <div className="flex items-center gap-1 mt-2">
                                <span className="text-yellow-400">‚òÖ</span>
                                <span className="text-sm font-bold text-gray-700">{place.rating}</span>
                            </div>
                        </div>
                        <div className="coupon-badge rounded px-3 py-1 text-xs font-bold text-right">
                            üéüÔ∏è {place.coupon}
                        </div>
                    </div>
                </div>
            );

            const ProfileModal = ({ userId }) => {
                const profile = getUserById(userId);
                const isFollowing = currentUser?.following.includes(userId);
                const isSelf = userId === currentUserId;

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="nexus-card rounded-lg p-8 max-w-md w-full mx-4">
                            <div className="flex justify-between items-start mb-4">
                                <div className="text-5xl">{profile?.avatar}</div>
                                <button onClick={() => setSelectedProfile(null)} className="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                            </div>
                            <h2 className="text-2xl font-bold text-gray-900">{profile?.name}</h2>
                            <p className="text-gray-600 text-sm">{profile?.username}</p>
                            <div className="flex gap-2 mt-2">
                                <div className="nexus-phase inline-block px-3 py-1 rounded text-xs font-bold">
                                    {profile?.phase}
                                </div>
                                <div className="mbti-badge">{profile?.mbti}</div>
                            </div>
                            <div className="flex items-center gap-2 mt-3 text-blue-600 text-sm">
                                <span className="location-marker"></span>
                                üìç {profile?.location}
                            </div>
                            <p className="mt-4 text-gray-700 text-sm">{profile?.bio}</p>
                            <div className="flex gap-6 mt-6 text-sm">
                                <div><span className="font-bold text-gray-900">{profile?.followers.length}</span> <span className="text-gray-600">„Éï„Ç©„É≠„ÉØ„Éº</span></div>
                                <div><span className="font-bold text-gray-900">{profile?.following.length}</span> <span className="text-gray-600">„Éï„Ç©„É≠„Éº‰∏≠</span></div>
                            </div>
                            {!isSelf && (
                                <div className="flex gap-2 mt-6">
                                    <button
                                        onClick={() => handleFollowToggle(userId)}
                                        className={`flex-1 py-2 rounded font-bold transition ${
                                            isFollowing
                                                ? 'bg-gray-200 text-gray-900 hover:bg-gray-300'
                                                : 'nexus-button'
                                        }`}
                                    >
                                        {isFollowing ? '„Éï„Ç©„É≠„Éº‰∏≠' : '„Éï„Ç©„É≠„Éº'}
                                    </button>
                                    <button
                                        onClick={() => {
                                            setSelectedProfile(null);
                                            setSelectedTalk(userId);
                                        }}
                                        className="flex-1 nexus-button rounded font-bold"
                                    >
                                        DMÈÄÅ‰ø°
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const TalkDetailModal = ({ participantId }) => {
                const participant = getUserById(participantId);
                const talkMessages = getTalkMessages(participantId);

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="nexus-card rounded-lg w-full max-w-md h-screen md:h-auto md:max-h-96 flex flex-col">
                            <div className="border-b border-gray-200 p-4 flex items-center justify-between bg-gradient-to-r from-blue-50 to-blue-100">
                                <div className="flex items-center gap-2">
                                    <span className="text-3xl">{participant?.avatar}</span>
                                    <div>
                                        <h3 className="font-bold text-gray-900">{participant?.name}</h3>
                                        <p className="text-xs text-gray-500">{participant?.phase}</p>
                                    </div>
                                </div>
                                <button onClick={() => setSelectedTalk(null)} className="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-white">
                                {talkMessages.length === 0 ? (
                                    <div className="flex items-center justify-center h-full text-gray-400">
                                        <p>„É°„ÉÉ„Çª„Éº„Ç∏„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                    </div>
                                ) : (
                                    talkMessages.map(msg => (
                                        <div key={msg.id} className={`flex ${msg.senderId === currentUserId ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`message-bubble p-3 rounded-lg max-w-xs ${msg.senderId === currentUserId ? 'bg-gradient-to-r from-blue-400 to-blue-500 text-white' : 'bg-gray-100 text-gray-900'}`}>
                                                <p className="text-sm">{msg.message}</p>
                                                <p className="text-xs opacity-70 mt-1">{formatTime(msg.timestamp)}</p>
                                            </div>
                                        </div>
                                    ))
                                )}
                                <div ref={messagesEndRef} />
                            </div>

                            <div className="border-t border-gray-200 p-4 flex gap-2 bg-gray-50">
                                <input
                                    type="text"
                                    value={newMessageContent}
                                    onChange={(e) => setNewMessageContent(e.target.value)}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter' && newMessageContent.trim()) {
                                            handleSendMessage(participantId);
                                        }
                                    }}
                                    placeholder="Ëøî‰ø°„ÇíÂÖ•Âäõ..."
                                    className="nexus-input flex-1 rounded px-3 py-2"
                                />
                                <button
                                    onClick={() => handleSendMessage(participantId)}
                                    disabled={!newMessageContent.trim()}
                                    className="nexus-button rounded px-4 py-2 font-bold disabled:opacity-50"
                                >
                                    ÈÄÅ‰ø°
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const GroupChatDetailModal = ({ groupChatId }) => {
                const groupChat = groupChats.find(g => g.id === groupChatId);
                const groupChatMessages = getGroupChatMessages(groupChatId);

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="nexus-card rounded-lg w-full max-w-md h-screen md:h-auto md:max-h-96 flex flex-col">
                            <div className="border-b border-gray-200 p-4 flex items-center justify-between bg-gradient-to-r from-blue-50 to-blue-100">
                                <h3 className="font-bold text-gray-900">{groupChat?.name}</h3>
                                <button onClick={() => setSelectedGroupChat(null)} className="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-white">
                                {groupChatMessages.length === 0 ? (
                                    <div className="flex items-center justify-center h-full text-gray-400">
                                        <p>„É°„ÉÉ„Çª„Éº„Ç∏„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                    </div>
                                ) : (
                                    groupChatMessages.map(msg => {
                                        const msgAuthor = getUserById(msg.senderId);
                                        return (
                                            <div key={msg.id} className={`flex ${msg.senderId === currentUserId ? 'justify-end' : 'justify-start'}`}>
                                                <div className={`p-3 rounded-lg max-w-xs ${msg.senderId === currentUserId ? 'bg-gradient-to-r from-blue-400 to-blue-500 text-white' : 'bg-gray-100 text-gray-900'}`}>
                                                    {msg.senderId !== currentUserId && <p className="text-xs font-bold mb-1">{msgAuthor?.name}</p>}
                                                    <p className="text-sm">{msg.content}</p>
                                                    <p className="text-xs opacity-70 mt-1">{formatTime(msg.timestamp)}</p>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                                <div ref={messagesEndRef} />
                            </div>

                            <div className="border-t border-gray-200 p-4 flex gap-2 bg-gray-50">
                                <input
                                    type="text"
                                    value={newMessageContent}
                                    onChange={(e) => setNewMessageContent(e.target.value)}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter' && newMessageContent.trim()) {
                                            handleSendGroupMessage(groupChatId);
                                        }
                                    }}
                                    placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..."
                                    className="nexus-input flex-1 rounded px-3 py-2"
                                />
                                <button
                                    onClick={() => handleSendGroupMessage(groupChatId)}
                                    disabled={!newMessageContent.trim()}
                                    className="nexus-button rounded px-4 py-2 font-bold disabled:opacity-50"
                                >
                                    ÈÄÅ‰ø°
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };return (
                <div className="h-screen nexus-bg flex flex-col">
                    {/* „Éò„ÉÉ„ÉÄ„Éº */}
                    <div className="border-b border-blue-200 sticky top-0 bg-white bg-opacity-95 backdrop-blur z-40 shadow-sm">
                        <div className="max-w-3xl mx-auto px-4 py-4">
                            <div className="flex items-center justify-between mb-4">
                                <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-blue-500 bg-clip-text text-transparent">
                                    NEXUS
                                </h1>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setActiveTab('posts')}
                                        className={`px-4 py-2 font-bold border-b-2 transition ${
                                            activeTab === 'posts' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600'
                                        }`}
                                    >
                                        ÊäïÁ®ø
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('messenger')}
                                        className={`px-4 py-2 font-bold border-b-2 transition relative ${
                                            activeTab === 'messenger' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600'
                                        }`}
                                    >
                                        Messenger
                                        {(getUnreadDMCount() + getUnreadGroupCount() > 0) && (
                                            <span className="nexus-notification rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold absolute -top-1 -right-2">
                                                {getUnreadDMCount() + getUnreadGroupCount()}
                                            </span>
                                        )}
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('locations')}
                                        className={`px-4 py-2 font-bold border-b-2 transition ${
                                            activeTab === 'locations' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600'
                                        }`}
                                    >
                                        ‰ΩçÁΩÆÊÉÖÂ†±
                                    </button>
                                </div>
                                <div className="text-2xl">{currentUser?.avatar}</div>
                            </div>

                            {/* Ê§úÁ¥¢„Éê„Éº */}
                            {activeTab === 'posts' && (
                                <div className="relative">
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        placeholder="üîç ÊäïÁ®ø„ÄÅ„É¶„Éº„Ç∂„Éº„ÄÅ„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞„ÇíÊ§úÁ¥¢..."
                                        className="nexus-input w-full rounded-full px-4 py-2 text-sm"
                                    />
                                </div>
                            )}
                        </div>
                    </div>

                    {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
                    <div className="flex-1 overflow-y-auto max-w-3xl mx-auto w-full">
                        {activeTab === 'posts' && (
                            <>
                                {/* ÊäïÁ®ø‰ΩúÊàê */}
                                <div className="nexus-card border-b p-4 m-4 rounded-lg shadow-sm">
                                    <div className="flex gap-3">
                                        <div className="text-3xl">{currentUser?.avatar}</div>
                                        <div className="flex-1">
                                            <textarea
                                                value={newPostContent}
                                                onChange={(e) => setNewPostContent(e.target.value)}
                                                placeholder="‰Ωï„ÅãÊñ∞„Åó„ÅÑ„Å§„Å™„Åå„Çä„Çí‰Ωú„Çç„ÅÜÔºÅ"
                                                className="nexus-input w-full rounded-lg p-3 resize-none"
                                                rows="3"
                                            />
                                            <div className="flex items-center gap-2 mt-2 text-sm text-gray-600">
                                                <span className="location-marker"></span>
                                                üìç {currentUser?.location}
                                                <span className="mbti-badge">{currentUser?.mbti}</span>
                                            </div>
                                            <button
                                                onClick={handleAddPost}
                                                disabled={!newPostContent.trim()}
                                                className="nexus-button mt-3 px-6 py-2 rounded-full font-bold"
                                            >
                                                ÊäïÁ®ø„Åô„Çã
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* MBTI „Éï„Ç£„É´„Çø„Éº */}
                                <div className="nexus-card border-b p-4 m-4 rounded-lg">
                                    <div className="flex gap-2 flex-wrap">
                                        <button
                                            onClick={() => setMbtiFilter('all')}
                                            className={`px-3 py-1 rounded text-sm font-bold ${mbtiFilter === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-900'}`}
                                        >
                                            ÂÖ®Âì°
                                        </button>
                                        {['ENFP', 'INTJ', 'ENFJ', 'INFP'].map(mbti => (
                                            <button
                                                key={mbti}
                                                onClick={() => setMbtiFilter(mbti)}
                                                className={`px-3 py-1 rounded text-sm font-bold ${mbtiFilter === mbti ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-900'}`}
                                            >
                                                {mbti}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* „Éï„Ç£„Éº„Éâ„Çø„Éñ */}
                                {!searchQuery && (
                                    <div className="nexus-card border-b flex sticky top-16 bg-white bg-opacity-95 z-30">
                                        <button
                                            onClick={() => setFeedType('recommend')}
                                            className={`flex-1 px-4 py-3 font-bold border-b-2 transition ${
                                                feedType === 'recommend' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600'
                                            }`}
                                        >
                                            „Åä„Åô„Åô„ÇÅ
                                        </button>
                                        <button
                                            onClick={() => setFeedType('following')}
                                            className={`flex-1 px-4 py-3 font-bold border-b-2 transition ${
                                                feedType === 'following' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600'
                                            }`}
                                        >
                                            „Éï„Ç©„É≠„Éº‰∏≠
                                        </button>
                                    </div>
                                )}

                                {/* ÊäïÁ®ø„Éï„Ç£„Éº„Éâ */}
                                <div className="p-4">
                                    {displayPosts.length > 0 ? (
                                        displayPosts.map(post => <PostCard key={post.id} post={post} />)
                                    ) : (
                                        <div className="p-8 text-center text-gray-500 nexus-card rounded-lg">
                                            {searchQuery ? 'Ê§úÁ¥¢ÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì' : 'ÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'}
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {activeTab === 'messenger' && (
                            <>
                                {/* Messenger „Çø„Éñ */}
                                <div className="nexus-card border-b flex sticky top-16 bg-white bg-opacity-95 z-30">
                                    <button
                                        onClick={() => setMessengerMode('dm')}
                                        className={`flex-1 px-4 py-3 font-bold border-b-2 transition ${
                                            messengerMode === 'dm' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600'
                                        }`}
                                    >
                                        DM
                                    </button>
                                    <button
                                        onClick={() => setMessengerMode('group')}
                                        className={`flex-1 px-4 py-3 font-bold border-b-2 transition ${
                                            messengerMode === 'group' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600'
                                        }`}
                                    >
                                        „Ç∞„É´„Éº„Éó
                                    </button>
                                </div>

                                {messengerMode === 'dm' && (
                                    <div className="p-4">
                                        {talks.length > 0 ? (
                                            talks.map(talk => <DMTalkCard key={talk.participantId} talk={talk} />)
                                        ) : (
                                            <div className="p-8 text-center text-gray-500 nexus-card rounded-lg">
                                                DM„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                                            </div>
                                        )}
                                    </div>
                                )}

                                {messengerMode === 'group' && (
                                    <div className="p-4">
                                        <div className="mb-4">
                                            <input
                                                type="text"
                                                value={newGroupChatName}
                                                onChange={(e) => setNewGroupChatName(e.target.value)}
                                                placeholder="„Ç∞„É´„Éº„ÉóÂêç„ÇíÂÖ•Âäõ..."
                                                className="nexus-input w-full rounded px-3 py-2 mb-2"
                                            />
                                            <button
                                                onClick={handleCreateGroupChat}
                                                disabled={!newGroupChatName.trim()}
                                                className="nexus-button w-full py-2 rounded font-bold disabled:opacity-50"
                                            >
                                                Êñ∞Ë¶è„Ç∞„É´„Éº„Éó‰ΩúÊàê
                                            </button>
                                        </div>
                                        {groupChats.length > 0 ? (
                                            groupChats.map(gc => <GroupChatCard key={gc.id} groupChat={gc} />)
                                        ) : (
                                            <div className="p-8 text-center text-gray-500 nexus-card rounded-lg">
                                                „Ç∞„É´„Éº„Éó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        )}

                        {activeTab === 'locations' && (
                            <div className="p-4">
                                {!selectedLocation ? (
                                    <>
                                        <div className="mb-4">
                                            <h3 className="text-lg font-bold text-gray-900 mb-3">üìç Ëøë„Åè„ÅÆ‰ª≤Èñì</h3>
                                            {locations.length > 0 ? (
                                                locations.map(location => <LocationCard key={location.id} location={location} />)
                                            ) : (
                                                <div className="p-8 text-center text-gray-500 nexus-card rounded-lg">
                                                    ‰ΩçÁΩÆÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                                                </div>
                                            )}
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <button
                                            onClick={() => {
                                                setSelectedLocation(null);
                                                setPlaces([]);
                                            }}
                                            className="mb-4 px-4 py-2 nexus-button rounded font-bold text-sm"
                                        >
                                            ‚Üê Êàª„Çã
                                        </button>
                                        <h3 className="text-lg font-bold text-gray-900 mb-3">
                                            üìç {selectedLocation} „ÅÆ„Åä„Åô„Åô„ÇÅ„Çπ„Éù„ÉÉ„Éà
                                        </h3>
                                        {places.length > 0 ? (
                                            places.map((place, i) => <PlaceCard key={i} place={place} />)
                                        ) : (
                                            <div className="p-8 text-center text-gray-500 nexus-card rounded-lg">
                                                „Åì„ÅÆÂ†¥ÊâÄ„Å´„ÅØ„Åä„Åô„Åô„ÇÅ„Çπ„Éù„ÉÉ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        )}
                    </div>

                    {/* „É¢„Éº„ÉÄ„É´ */}
                    {selectedProfile && <ProfileModal userId={selectedProfile} />}
                    {selectedTalk && <TalkDetailModal participantId={selectedTalk} />}
                    {selectedGroupChat && <GroupChatDetailModal groupChatId={selectedGroupChat} />}
                </div>
            );
        }

        ReactDOM.render(<NEXUS />, document.getElementById('root'));
    </script>
</body>
</html>
