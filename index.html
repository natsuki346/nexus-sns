<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS - ÊåëÊà¶ËÄÖÁâπÂåñÂûãSNS</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
        }
        .nexus-bg {
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
        }
        .nexus-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e0e7ff;
        }
        .nexus-button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }
        .nexus-button:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .nexus-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .nexus-input {
            border: 2px solid #e0e7ff;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }
        .nexus-input:focus {
            border-color: #3b82f6;
            background: white;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .nexus-notification {
            background: #ef4444;
            color: white;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .nexus-tag {
            color: #3b82f6;
            font-weight: 500;
        }
        .nexus-phase {
            background: #dbeafe;
            color: #1e40af;
            border-left: 3px solid #3b82f6;
        }
        .nexus-like {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const API_BASE = '';

        function NEXUS() {
            const [users, setUsers] = useState([]);
            const [posts, setPosts] = useState([]);
            const [messages, setMessages] = useState([]);
            const [currentUserId] = useState('user1');
            const [activeTab, setActiveTab] = useState('posts');
            const [feedType, setFeedType] = useState('recommend');
            const [selectedTalk, setSelectedTalk] = useState(null);
            const [selectedProfile, setSelectedProfile] = useState(null);
            const [newPostContent, setNewPostContent] = useState('');
            const [newMessageContent, setNewMessageContent] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetchData();
            }, []);

            const fetchData = async () => {
                try {
                    const [usersRes, postsRes, messagesRes] = await Promise.all([
                        fetch(`${API_BASE}/api/users`),
                        fetch(`${API_BASE}/api/posts`),
                        fetch(`${API_BASE}/api/messages`)
                    ]);

                    const usersData = await usersRes.json();
                    const postsData = await postsRes.json();
                    const messagesData = await messagesRes.json();

                    setUsers(usersData);
                    setPosts(postsData);
                    setMessages(messagesData);
                    setLoading(false);
                } catch (error) {
                    console.error('Failed to fetch data:', error);
                    setLoading(false);
                }
            };

            const getCurrentUser = () => users.find(u => u.id === currentUserId);
            const getUserById = (id) => users.find(u => u.id === id);
            const getPostAuthor = (post) => getUserById(post.authorId);

            const getUnreadDMCount = () => {
                return messages.filter(m => m.recipientId === currentUserId && !m.isRead).length;
            };

            const getTalks = () => {
                const talkMap = {};
                messages.forEach(msg => {
                    const otherId = msg.senderId === currentUserId ? msg.recipientId : msg.senderId;
                    if (!talkMap[otherId]) {
                        talkMap[otherId] = {
                            participantId: otherId,
                            messages: [],
                            lastMessage: '',
                            lastMessageTime: ''
                        };
                    }
                    talkMap[otherId].messages.push(msg);
                    talkMap[otherId].lastMessage = msg.message;
                    talkMap[otherId].lastMessageTime = msg.timestamp;
                });
                return Object.values(talkMap).sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
            };

            const getTalkMessages = (participantId) => {
                return messages.filter(
                    m => (m.senderId === currentUserId && m.recipientId === participantId) ||
                         (m.senderId === participantId && m.recipientId === currentUserId)
                ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            };

            const getSearchResults = () => {
                const query = searchQuery.toLowerCase();
                return posts.filter(post => {
                    const author = getPostAuthor(post);
                    return (
                        post.content.toLowerCase().includes(query) ||
                        author?.name.toLowerCase().includes(query) ||
                        author?.username.toLowerCase().includes(query) ||
                        post.hashtags?.some(tag => tag.toLowerCase().includes(query))
                    );
                });
            };

            const handleAddPost = async () => {
                if (newPostContent.trim()) {
                    try {
                        const response = await fetch(`${API_BASE}/api/posts`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ authorId: currentUserId, content: newPostContent })
                        });
                        const newPost = await response.json();
                        setPosts([newPost, ...posts]);
                        setNewPostContent('');
                    } catch (error) {
                        console.error('Failed to create post:', error);
                    }
                }
            };

            const handleToggleLike = async (postId) => {
                try {
                    const response = await fetch(`${API_BASE}/api/posts/${postId}/like`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUserId })
                    });
                    const updatedPost = await response.json();
                    setPosts(posts.map(p => p.id === postId ? updatedPost : p));
                } catch (error) {
                    console.error('Failed to toggle like:', error);
                }
            };

            const handleFollowToggle = (userId) => {
                setUsers(users.map(u => {
                    if (u.id === currentUserId) {
                        return {
                            ...u,
                            following: u.following.includes(userId) 
                                ? u.following.filter(id => id !== userId)
                                : [...u.following, userId]
                        };
                    }
                    if (u.id === userId) {
                        return {
                            ...u,
                            followers: u.followers.includes(currentUserId)
                                ? u.followers.filter(id => id !== currentUserId)
                                : [...u.followers, currentUserId]
                        };
                    }
                    return u;
                }));
            };

            const handleSendMessage = async (recipientId) => {
                if (newMessageContent.trim()) {
                    try {
                        const response = await fetch(`${API_BASE}/api/messages`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ senderId: currentUserId, recipientId, message: newMessageContent })
                        });
                        const newMsg = await response.json();
                        setMessages([...messages, newMsg]);
                        setNewMessageContent('');
                    } catch (error) {
                        console.error('Failed to send message:', error);
                    }
                }
            };

            const handleMarkAsRead = (participantId) => {
                setMessages(messages.map(m => {
                    if (m.recipientId === currentUserId && m.senderId === participantId && !m.isRead) {
                        return { ...m, isRead: true };
                    }
                    return m;
                }));
            };

            const getFilteredPosts = () => {
                let filtered = posts;
                
                if (feedType === 'following') {
                    const followingIds = getCurrentUser()?.following || [];
                    filtered = filtered.filter(p => followingIds.includes(p.authorId));
                }
                
                return filtered;
            };

            const formatTime = (timestamp) => {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return '‰ªä';
                if (minutes < 60) return `${minutes}ÂàÜÂâç`;
                if (hours < 24) return `${hours}ÊôÇÈñìÂâç`;
                if (days < 7) return `${days}Êó•Ââç`;
                return date.toLocaleDateString('ja-JP');
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-screen nexus-bg">
                        <div className="text-center">
                            <div className="text-4xl mb-4">üì±</div>
                            <p className="text-gray-600 text-lg">NEXUS Ë™≠Ëæº‰∏≠...</p>
                        </div>
                    </div>
                );
            }

            const currentUser = getCurrentUser();
            if (!currentUser) return <div className="text-center p-8">„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>;

            const displayPosts = searchQuery ? getSearchResults() : getFilteredPosts();
            const talks = getTalks();

            const PostCard = ({ post }) => {
                const author = getPostAuthor(post);
                const isLiked = post.likes.includes(currentUserId);

                return (
                    <div className="nexus-card border-b hover:bg-blue-50 transition p-4">
                        <div className="flex gap-3">
                            <div className="text-3xl">{author?.avatar}</div>
                            <div className="flex-1">
                                <div className="flex items-center gap-2 flex-wrap">
                                    <span className="font-bold hover:underline cursor-pointer text-gray-900" onClick={() => setSelectedProfile(author?.id)}>
                                        {author?.name}
                                    </span>
                                    <span className="text-gray-500 text-sm">{author?.username}</span>
                                    <span className="nexus-phase px-2 py-1 rounded text-xs font-bold">
                                        {author?.phase}
                                    </span>
                                    <span className="text-gray-400 text-xs ml-auto">{formatTime(post.timestamp)}</span>
                                </div>
                                <p className="mt-3 text-gray-800 text-sm leading-relaxed">{post.content}</p>
                                {post.hashtags && post.hashtags.length > 0 && (
                                    <div className="mt-3 flex flex-wrap gap-2">
                                        {post.hashtags.map((tag, i) => (
                                            <span key={i} className="nexus-tag text-sm">
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                )}
                                <div className="flex items-center gap-6 mt-4 text-gray-500">
                                    <button
                                        onClick={() => handleToggleLike(post.id)}
                                        className={`flex items-center gap-2 transition ${isLiked ? 'nexus-like' : 'hover:text-red-500'}`}
                                    >
                                        <span className="text-lg">{isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                                        <span className={`text-sm font-bold ${isLiked ? 'nexus-like' : ''}`}>
                                            {post.likeCount}
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const DMTalkCard = ({ talk }) => {
                const participant = getUserById(talk.participantId);
                const unreadCount = getTalkMessages(talk.participantId).filter(m => m.recipientId === currentUserId && !m.isRead).length;

                return (
                    <div
                        onClick={() => {
                            setSelectedTalk(talk.participantId);
                            handleMarkAsRead(talk.participantId);
                        }}
                        className="nexus-card border-b hover:bg-blue-50 cursor-pointer transition p-4 flex items-center justify-between"
                    >
                        <div className="flex-1">
                            <div className="flex items-center gap-3">
                                <span className="text-2xl">{participant?.avatar}</span>
                                <div className="flex-1">
                                    <div className="font-bold text-gray-900">{participant?.name}</div>
                                    <div className="text-sm text-gray-600 truncate">{talk.lastMessage}</div>
                                </div>
                            </div>
                        </div>
                        {unreadCount > 0 && (
                            <div className="nexus-notification rounded-full w-7 h-7 flex items-center justify-center text-xs font-bold ml-3">
                                {unreadCount}
                            </div>
                        )}
                    </div>
                );
            };

            const ProfileModal = ({ userId }) => {
                const profile = getUserById(userId);
                const isFollowing = currentUser?.following.includes(userId);
                const isSelf = userId === currentUserId;

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="nexus-card rounded-lg p-8 max-w-md w-full mx-4">
                            <div className="flex justify-between items-start mb-4">
                                <div className="text-5xl">{profile?.avatar}</div>
                                <button onClick={() => setSelectedProfile(null)} className="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                            </div>
                            <h2 className="text-2xl font-bold text-gray-900">{profile?.name}</h2>
                            <p className="text-gray-600 text-sm">{profile?.username}</p>
                            <div className="nexus-phase inline-block px-3 py-1 rounded text-xs font-bold mt-3">
                                {profile?.phase}
                            </div>
                            <p className="mt-4 text-gray-700 text-sm">{profile?.bio}</p>
                            <div className="flex gap-6 mt-6 text-sm">
                                <div><span className="font-bold text-gray-900">{profile?.followers.length}</span> <span className="text-gray-600">„Éï„Ç©„É≠„ÉØ„Éº</span></div>
                                <div><span className="font-bold text-gray-900">{profile?.following.length}</span> <span className="text-gray-600">„Éï„Ç©„É≠„Éº‰∏≠</span></div>
                            </div>
                            {!isSelf && (
                                <div className="flex gap-2 mt-6">
                                    <button
                                        onClick={() => handleFollowToggle(userId)}
                                        className={`flex-1 py-2 rounded font-bold transition ${
                                            isFollowing
                                                ? 'bg-gray-200 text-gray-900 hover:bg-gray-300'
                                                : 'nexus-button'
                                        }`}
                                    >
                                        {isFollowing ? '„Éï„Ç©„É≠„Éº‰∏≠' : '„Éï„Ç©„É≠„Éº'}
                                    </button>
                                    <button
                                        onClick={() => {
                                            setSelectedProfile(null);
                                            setSelectedTalk(userId);
                                        }}
                                        className="flex-1 nexus-button rounded font-bold"
                                    >
                                        DMÈÄÅ‰ø°
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const TalkDetailModal = ({ participantId }) => {
                const participant = getUserById(participantId);
                const talkMessages = getTalkMessages(participantId);

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="nexus-card rounded-lg w-full max-w-md h-screen md:h-auto md:max-h-96 flex flex-col">
                            <div className="border-b border-gray-200 p-4 flex items-center justify-between bg-gradient-to-r from-blue-50 to-blue-100">
                                <div className="flex items-center gap-2">
                                    <span className="text-3xl">{participant?.avatar}</span>
                                    <h3 className="font-bold text-gray-900">{participant?.name}</h3>
                                </div>
                                <button onClick={() => setSelectedTalk(null)} className="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-white">
                                {talkMessages.map(msg => (
                                    <div key={msg.id} className={`flex ${msg.senderId === currentUserId ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`p-3 rounded-lg max-w-xs ${msg.senderId === currentUserId ? 'bg-gradient-to-r from-blue-400 to-blue-500 text-white' : 'bg-gray-100 text-gray-900'}`}>
                                            <p className="text-sm">{msg.message}</p>
                                            <p className="text-xs opacity-70 mt-1">{formatTime(msg.timestamp)}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="border-t border-gray-200 p-4 flex gap-2 bg-gray-50">
                                <input
                                    type="text"
                                    value={newMessageContent}
                                    onChange={(e) => setNewMessageContent(e.target.value)}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter') {
                                            handleSendMessage(participantId);
                                        }
                                    }}
                                    placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..."
                                    className="nexus-input flex-1 rounded px-3 py-2"
                                />
                                <button
                                    onClick={() => handleSendMessage(participantId)}
                                    className="nexus-button rounded px-4 py-2 font-bold"
                                >
                                    ÈÄÅ‰ø°
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-screen nexus-bg flex flex-col">
                    {/* „Éò„ÉÉ„ÉÄ„Éº */}
                    <div className="border-b border-blue-200 sticky top-0 bg-white bg-opacity-95 backdrop-blur z-40 shadow-sm">
                        <div className="max-w-3xl mx-auto px-4 py-4">
                            <div className="flex items-center justify-between mb-4">
                                <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-blue-500 bg-clip-text text-transparent">
                                    NEXUS
                                </h1>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setActiveTab('posts')}
                                        className={`px-4 py-2 font-bold border-b-2 transition ${
                                            activeTab === 'posts' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600'
                                        }`}
                                    >
                                        ÊäïÁ®ø
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('dms')}
                                        className={`px-4 py-2 font-bold border-b-2 transition relative ${
                                            activeTab === 'dms' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600'
                                        }`}
                                    >
                                        DM
                                        {getUnreadDMCount() > 0 && (
                                            <span className="nexus-notification rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold absolute -top-1 -right-2">
                                                {getUnreadDMCount()}
                                            </span>
                                        )}
                                    </button>
                                </div>
                                <div className="text-2xl">{currentUser?.avatar}</div>
                            </div>

                            {/* Ê§úÁ¥¢„Éê„Éº */}
                            {activeTab === 'posts' && (
                                <div className="relative">
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        placeholder="üîç ÊäïÁ®ø„ÄÅ„É¶„Éº„Ç∂„Éº„ÄÅ„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞„ÇíÊ§úÁ¥¢..."
                                        className="nexus-input w-full rounded-full px-4 py-2 text-sm"
                                    />
                                </div>
                            )}
                        </div>
                    </div>

                    {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
                    <div className="flex-1 overflow-y-auto max-w-3xl mx-auto w-full">
                        {activeTab === 'posts' && (
                            <>
                                {/* ÊäïÁ®ø‰ΩúÊàê */}
                                <div className="nexus-card border-b p-4 m-4 rounded-lg shadow-sm">
                                    <div className="flex gap-3">
                                        <div className="text-3xl">{currentUser?.avatar}</div>
                                        <div className="flex-1">
                                            <textarea
                                                value={newPostContent}
                                                onChange={(e) => setNewPostContent(e.target.value)}
                                                placeholder="‰Ωï„ÅãÊñ∞„Åó„ÅÑ„Å§„Å™„Åå„Çä„Çí‰Ωú„Çç„ÅÜÔºÅ"
                                                className="nexus-input w-full rounded-lg p-3 resize-none"
                                                rows="3"
                                            />
                                            <button
                                                onClick={handleAddPost}
                                                disabled={!newPostContent.trim()}
                                                className="nexus-button mt-3 px-6 py-2 rounded-full font-bold"
                                            >
                                                ÊäïÁ®ø„Åô„Çã
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* „Éï„Ç£„Éº„Éâ„Çø„Éñ */}
                                {!searchQuery && (
                                    <div className="nexus-card border-b flex sticky top-16 bg-white bg-opacity-95 z-30">
                                        <button
                                            onClick={() => setFeedType('recommend')}
                                            className={`flex-1 px-4 py-3 font-bold border-b-2 transition ${
                                                feedType === 'recommend' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600'
                                            }`}
                                        >
                                            „Åä„Åô„Åô„ÇÅ
                                        </button>
                                        <button
                                            onClick={() => setFeedType('following')}
                                            className={`flex-1 px-4 py-3 font-bold border-b-2 transition ${
                                                feedType === 'following' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600'
                                            }`}
                                        >
                                            „Éï„Ç©„É≠„Éº‰∏≠
                                        </button>
                                    </div>
                                )}

                                {/* ÊäïÁ®ø„Éï„Ç£„Éº„Éâ */}
                                <div className="p-4">
                                    {displayPosts.length > 0 ? (
                                        displayPosts.map(post => <PostCard key={post.id} post={post} />)
                                    ) : (
                                        <div className="p-8 text-center text-gray-500 nexus-card rounded-lg">
                                            {searchQuery ? 'Ê§úÁ¥¢ÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì' : 'ÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'}
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {activeTab === 'dms' && (
                            <div className="p-4">
                                {talks.length > 0 ? (
                                    talks.map(talk => <DMTalkCard key={talk.participantId} talk={talk} />)
                                ) : (
                                    <div className="p-8 text-center text-gray-500 nexus-card rounded-lg">
                                        DM„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* „É¢„Éº„ÉÄ„É´ */}
                    {selectedProfile && <ProfileModal userId={selectedProfile} />}
                    {selectedTalk && <TalkDetailModal participantId={selectedTalk} />}
                </div>
            );
        }

        ReactDOM.render(<NEXUS />, document.getElementById('root'));
    </script>
</body>
</html>
