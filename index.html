<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS - 挑戦者特化型SNS</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Heart, Send, X } = window.LucideReact || {};

        const API_BASE = '';

        function NEXUS() {
            const [users, setUsers] = useState([]);
            const [posts, setPosts] = useState([]);
            const [messages, setMessages] = useState([]);
            const [currentUserId] = useState('user1');
            const [activeTab, setActiveTab] = useState('posts');
            const [feedType, setFeedType] = useState('recommend');
            const [selectedTalk, setSelectedTalk] = useState(null);
            const [selectedProfile, setSelectedProfile] = useState(null);
            const [newPostContent, setNewPostContent] = useState('');
            const [newMessageContent, setNewMessageContent] = useState('');
            const [previewTalk, setPreviewTalk] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetchData();
            }, []);

            const fetchData = async () => {
                try {
                    const [usersRes, postsRes, messagesRes] = await Promise.all([
                        fetch(`${API_BASE}/api/users`),
                        fetch(`${API_BASE}/api/posts`),
                        fetch(`${API_BASE}/api/messages`)
                    ]);

                    const usersData = await usersRes.json();
                    const postsData = await postsRes.json();
                    const messagesData = await messagesRes.json();

                    setUsers(usersData);
                    setPosts(postsData);
                    setMessages(messagesData);
                    setLoading(false);
                } catch (error) {
                    console.error('Failed to fetch data:', error);
                    setLoading(false);
                }
            };

            const getCurrentUser = () => users.find(u => u.id === currentUserId);
            const getUserById = (id) => users.find(u => u.id === id);
            const getPostAuthor = (post) => getUserById(post.authorId);

            const getUnreadDMCount = () => {
                return messages.filter(m => m.recipientId === currentUserId && !m.isRead).length;
            };

            const getTalks = () => {
                const talkMap = {};
                messages.forEach(msg => {
                    const otherId = msg.senderId === currentUserId ? msg.recipientId : msg.senderId;
                    if (!talkMap[otherId]) {
                        talkMap[otherId] = {
                            participantId: otherId,
                            messages: [],
                            lastMessage: '',
                            lastMessageTime: ''
                        };
                    }
                    talkMap[otherId].messages.push(msg);
                    talkMap[otherId].lastMessage = msg.message;
                    talkMap[otherId].lastMessageTime = msg.timestamp;
                });
                return Object.values(talkMap).sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
            };

            const getTalkMessages = (participantId) => {
                return messages.filter(
                    m => (m.senderId === currentUserId && m.recipientId === participantId) ||
                         (m.senderId === participantId && m.recipientId === currentUserId)
                ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            };

            const handleAddPost = async () => {
                if (newPostContent.trim()) {
                    try {
                        const response = await fetch(`${API_BASE}/api/posts`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ authorId: currentUserId, content: newPostContent })
                        });
                        const newPost = await response.json();
                        setPosts([newPost, ...posts]);
                        setNewPostContent('');
                    } catch (error) {
                        console.error('Failed to create post:', error);
                    }
                }
            };

            const handleToggleLike = async (postId) => {
                try {
                    const response = await fetch(`${API_BASE}/api/posts/${postId}/like`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUserId })
                    });
                    const updatedPost = await response.json();
                    setPosts(posts.map(p => p.id === postId ? updatedPost : p));
                } catch (error) {
                    console.error('Failed to toggle like:', error);
                }
            };

            const handleFollowToggle = (userId) => {
                setUsers(users.map(u => {
                    if (u.id === currentUserId) {
                        return {
                            ...u,
                            following: u.following.includes(userId) 
                                ? u.following.filter(id => id !== userId)
                                : [...u.following, userId]
                        };
                    }
                    if (u.id === userId) {
                        return {
                            ...u,
                            followers: u.followers.includes(currentUserId)
                                ? u.followers.filter(id => id !== currentUserId)
                                : [...u.followers, currentUserId]
                        };
                    }
                    return u;
                }));
            };

            const handleSendMessage = async (recipientId) => {
                if (newMessageContent.trim()) {
                    try {
                        const response = await fetch(`${API_BASE}/api/messages`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ senderId: currentUserId, recipientId, message: newMessageContent })
                        });
                        const newMsg = await response.json();
                        setMessages([...messages, newMsg]);
                        setNewMessageContent('');
                    } catch (error) {
                        console.error('Failed to send message:', error);
                    }
                }
            };

            const handleMarkAsRead = (participantId) => {
                setMessages(messages.map(m => {
                    if (m.recipientId === currentUserId && m.senderId === participantId && !m.isRead) {
                        return { ...m, isRead: true };
                    }
                    return m;
                }));
            };

            const getFilteredPosts = () => {
                if (feedType === 'recommend') {
                    return posts;
                } else {
                    const followingIds = getCurrentUser()?.following || [];
                    return posts.filter(p => followingIds.includes(p.authorId));
                }
            };

            const formatTime = (timestamp) => {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return '今';
                if (minutes < 60) return `${minutes}分前`;
                if (hours < 24) return `${hours}時間前`;
                if (days < 7) return `${days}日前`;
                return date.toLocaleDateString('ja-JP');
            };

            if (loading) {
                return <div className="flex items-center justify-center h-screen"><p>読込中...</p></div>;
            }

            const currentUser = getCurrentUser();
            if (!currentUser) return <div>ユーザーが見つかりません</div>;

            const filteredPosts = getFilteredPosts();
            const talks = getTalks();

            const PostCard = ({ post }) => {
                const author = getPostAuthor(post);
                const isLiked = post.likes.includes(currentUserId);

                return (
                    <div className="border-b border-gray-200 p-4 hover:bg-gray-50 transition">
                        <div className="flex gap-3">
                            <div className="text-3xl">{author?.avatar}</div>
                            <div className="flex-1">
                                <div className="flex items-center gap-2">
                                    <span className="font-bold hover:underline cursor-pointer" onClick={() => setSelectedProfile(author?.id)}>
                                        {author?.name}
                                    </span>
                                    <span className="text-gray-500">{author?.username}</span>
                                    <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                        {author?.phase}
                                    </span>
                                    <span className="text-gray-500 text-sm ml-auto">{formatTime(post.timestamp)}</span>
                                </div>
                                <p className="mt-2 text-gray-900">{post.content}</p>
                                {post.hashtags && post.hashtags.length > 0 && (
                                    <div className="mt-2 flex flex-wrap gap-1">
                                        {post.hashtags.map((tag, i) => (
                                            <span key={i} className="text-blue-500 text-sm">
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                )}
                                <div className="flex items-center gap-8 mt-3 text-gray-500">
                                    <button
                                        onClick={() => handleToggleLike(post.id)}
                                        className="flex items-center gap-2 hover:text-red-500 transition"
                                    >
                                        <span>❤️</span>
                                        <span className="text-sm">{post.likeCount}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const DMTalkCard = ({ talk }) => {
                const participant = getUserById(talk.participantId);
                const unreadCount = getTalkMessages(talk.participantId).filter(m => m.recipientId === currentUserId && !m.isRead).length;

                return (
                    <div
                        onClick={() => {
                            setSelectedTalk(talk.participantId);
                            handleMarkAsRead(talk.participantId);
                        }}
                        className="border-b border-gray-200 p-4 hover:bg-gray-50 cursor-pointer transition flex items-center justify-between"
                    >
                        <div className="flex-1">
                            <div className="flex items-center gap-2">
                                <span className="text-2xl">{participant?.avatar}</span>
                                <div className="flex-1">
                                    <div className="font-bold">{participant?.name}</div>
                                    <div className="text-sm text-gray-600 truncate">{talk.lastMessage}</div>
                                </div>
                            </div>
                        </div>
                        {unreadCount > 0 && (
                            <div className="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold ml-2">
                                {unreadCount}
                            </div>
                        )}
                    </div>
                );
            };

            const ProfileModal = ({ userId }) => {
                const profile = getUserById(userId);
                const isFollowing = currentUser?.following.includes(userId);
                const isSelf = userId === currentUserId;

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-lg p-8 max-w-md w-full mx-4">
                            <div className="flex justify-between items-start">
                                <div className="text-5xl">{profile?.avatar}</div>
                                <button onClick={() => setSelectedProfile(null)} className="text-gray-500">✕</button>
                            </div>
                            <h2 className="text-2xl font-bold mt-4">{profile?.name}</h2>
                            <p className="text-gray-600">{profile?.username}</p>
                            <div className="inline-block bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm mt-2">
                                {profile?.phase}
                            </div>
                            <p className="mt-4 text-gray-700">{profile?.bio}</p>
                            <div className="flex gap-4 mt-6 text-sm text-gray-600">
                                <div><span className="font-bold">{profile?.followers.length}</span> フォロワー</div>
                                <div><span className="font-bold">{profile?.following.length}</span> フォロー中</div>
                            </div>
                            {!isSelf && (
                                <div className="flex gap-2 mt-6">
                                    <button
                                        onClick={() => handleFollowToggle(userId)}
                                        className={`flex-1 py-2 rounded font-bold transition ${
                                            isFollowing
                                                ? 'bg-gray-200 text-gray-900'
                                                : 'bg-blue-500 text-white'
                                        }`}
                                    >
                                        {isFollowing ? 'フォロー中' : 'フォロー'}
                                    </button>
                                    <button
                                        onClick={() => {
                                            setSelectedProfile(null);
                                            setSelectedTalk(userId);
                                        }}
                                        className="flex-1 py-2 rounded font-bold bg-blue-500 text-white"
                                    >
                                        DM送信
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const TalkDetailModal = ({ participantId }) => {
                const participant = getUserById(participantId);
                const talkMessages = getTalkMessages(participantId);

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-lg w-full max-w-md h-screen md:h-auto md:max-h-96 flex flex-col">
                            <div className="border-b border-gray-200 p-4 flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <span className="text-3xl">{participant?.avatar}</span>
                                    <h3 className="font-bold text-lg">{participant?.name}</h3>
                                </div>
                                <button onClick={() => setSelectedTalk(null)}>✕</button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                {talkMessages.map(msg => (
                                    <div key={msg.id} className={`flex ${msg.senderId === currentUserId ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`p-3 rounded-lg max-w-xs ${msg.senderId === currentUserId ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}>
                                            <p className="text-sm">{msg.message}</p>
                                            <p className="text-xs opacity-70 mt-1">{formatTime(msg.timestamp)}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="border-t border-gray-200 p-4 flex gap-2">
                                <input
                                    type="text"
                                    value={newMessageContent}
                                    onChange={(e) => setNewMessageContent(e.target.value)}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter') {
                                            handleSendMessage(participantId);
                                        }
                                    }}
                                    placeholder="メッセージを入力..."
                                    className="flex-1 border border-gray-300 rounded px-3 py-2"
                                />
                                <button
                                    onClick={() => handleSendMessage(participantId)}
                                    className="bg-blue-500 text-white rounded px-4 py-2"
                                >
                                    送信
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-screen bg-white flex flex-col">
                    <div className="border-b border-gray-200 sticky top-0 bg-white z-40">
                        <div className="max-w-2xl mx-auto px-4 py-4 flex items-center justify-between">
                            <h1 className="text-2xl font-bold text-blue-600">NEXUS</h1>
                            <div className="flex gap-4">
                                <button
                                    onClick={() => setActiveTab('posts')}
                                    className={`px-4 py-2 font-bold border-b-2 ${
                                        activeTab === 'posts' ? 'border-blue-500 text-blue-600' : 'border-transparent'
                                    }`}
                                >
                                    投稿
                                </button>
                                <button
                                    onClick={() => setActiveTab('dms')}
                                    className={`px-4 py-2 font-bold border-b-2 relative ${
                                        activeTab === 'dms' ? 'border-blue-500 text-blue-600' : 'border-transparent'
                                    }`}
                                >
                                    DM
                                    {getUnreadDMCount() > 0 && (
                                        <span className="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                            {getUnreadDMCount()}
                                        </span>
                                    )}
                                </button>
                            </div>
                            <div className="text-2xl">{currentUser?.avatar}</div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto max-w-2xl mx-auto w-full">
                        {activeTab === 'posts' && (
                            <>
                                <div className="border-b border-gray-200 p-4 bg-gray-50">
                                    <div className="flex gap-3">
                                        <div className="text-3xl">{currentUser?.avatar}</div>
                                        <div className="flex-1">
                                            <textarea
                                                value={newPostContent}
                                                onChange={(e) => setNewPostContent(e.target.value)}
                                                placeholder="何か新しいつながりを作ろう！"
                                                className="w-full border border-gray-300 rounded-lg p-3 resize-none"
                                                rows="3"
                                            />
                                            <button
                                                onClick={handleAddPost}
                                                disabled={!newPostContent.trim()}
                                                className="mt-3 bg-blue-500 text-white px-6 py-2 rounded-full font-bold disabled:opacity-50"
                                            >
                                                投稿する
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="border-b border-gray-200 flex sticky top-16 bg-white z-30">
                                    <button
                                        onClick={() => setFeedType('recommend')}
                                        className={`flex-1 px-4 py-3 font-bold border-b-2 ${
                                            feedType === 'recommend' ? 'border-blue-500 text-blue-600' : 'border-transparent'
                                        }`}
                                    >
                                        おすすめ
                                    </button>
                                    <button
                                        onClick={() => setFeedType('following')}
                                        className={`flex-1 px-4 py-3 font-bold border-b-2 ${
                                            feedType === 'following' ? 'border-blue-500 text-blue-600' : 'border-transparent'
                                        }`}
                                    >
                                        フォロー中
                                    </button>
                                </div>

                                {filteredPosts.length > 0 ? (
                                    filteredPosts.map(post => <PostCard key={post.id} post={post} />)
                                ) : (
                                    <div className="p-8 text-center text-gray-500">投稿がありません</div>
                                )}
                            </>
                        )}

                        {activeTab === 'dms' && (
                            <>
                                {talks.length > 0 ? (
                                    talks.map(talk => <DMTalkCard key={talk.participantId} talk={talk} />)
                                ) : (
                                    <div className="p-8 text-center text-gray-500">DMがありません</div>
                                )}
                            </>
                        )}
                    </div>

                    {selectedProfile && <ProfileModal userId={selectedProfile} />}
                    {selectedTalk && <TalkDetailModal participantId={selectedTalk} />}
                </div>
            );
        }

        ReactDOM.render(<NEXUS />, document.getElementById('root'));
    </script>
</body>
</html>
